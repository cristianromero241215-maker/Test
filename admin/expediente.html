<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expediente Cl√≠nico</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="admin.css" />
</head>
<body class="dashboard">
  <header class="dash-header">
    <div class="dash-wrap">
      <div class="brand">
        <img src="../assets/logo.png" alt="Logo" />
        <strong>Expedientes</strong>
      </div>
      <nav class="dash-nav">
        <a href="dashboard.html">Citas</a>
        <a href="expediente.html" class="active">Expedientes</a>
        <button id="themeToggle" class="btn btn-icon" title="Tema"><span class="theme-toggle-icon">üåì</span></button>
        <button id="logoutBtn" class="btn btn-outline">Salir</button>
      </nav>
    </div>
  </header>

  <main class="dash-main">
    <div id="notification-container"></div>
    <div class="card">
      <h2>Nuevo Expediente</h2>
      <form id="expedienteForm">
        <div class="form-group">
          <label for="pacienteNombre">Nombre del Paciente</label>
          <input type="text" id="pacienteNombre" name="pacienteNombre" required />
        </div>
        <div class="form-group">
          <label for="pacienteTelefono">Tel√©fono</label>
          <input type="tel" id="pacienteTelefono" name="pacienteTelefono" pattern="[0-9]{10}" placeholder="10 d√≠gitos" required />
        </div>
        <div class="form-group">
          <label for="antecedentes">Antecedentes</label>
          <textarea id="antecedentes" name="antecedentes" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="diagnostico">Diagn√≥stico</label>
          <textarea id="diagnostico" name="diagnostico" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="tratamientoPlan">Plan de Tratamiento</label>
          <textarea id="tratamientoPlan" name="tratamientoPlan" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-google btn-primary">
          <span class="btn-text">Guardar Expediente</span>
        </button>
      </form>
    </div>
  </main>

  <script>
const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbztZyr_30qt21-lvAlBjg6pqHu6o5BeEueNXqiP7q8QF6QmIJLA5OckEaksn1NQAxZuyg/exec";

if (localStorage.getItem('isAdminLoggedIn') !== 'true') {
  window.location.href = 'login.html';
}

document.getElementById('logoutBtn')?.addEventListener('click', () => {
  localStorage.removeItem('isAdminLoggedIn');
  window.location.href = 'login.html';
});

function showNotification(message, type = 'success') {
  const container = document.getElementById('notification-container');
  if (!container) return;
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  container.appendChild(notification);
  setTimeout(() => { notification.remove(); }, 3000);
}

const form = document.getElementById('expedienteForm');
const submitBtn = form.querySelector('.btn-primary');

const root = document.documentElement;
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('adminTheme');
if (savedTheme) root.setAttribute('data-theme', savedTheme);

themeToggle?.addEventListener('click', () => {
  const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  root.setAttribute('data-theme', current);
  localStorage.setItem('adminTheme', current);
});

form?.addEventListener('submit', async (e) => {
  e.preventDefault();

  submitBtn.classList.add('loading');
  const btnText = submitBtn.querySelector('.btn-text');
  btnText.textContent = "Guardando...";

  const data = Object.fromEntries(new FormData(form).entries());
  data.action = 'addExpediente';

  try {
    const res = await fetch(SHEETS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await res.json();

    if (result.ok) {
      showNotification('‚úÖ Expediente guardado con √©xito!', 'success');
      form.reset();
    } else {
      throw new Error(result.message || 'Error desconocido.');
    }
  } catch (error) {
    showNotification('‚ùå Error al guardar el expediente.', 'error');
    console.error('Error al guardar el expediente:', error);
  } finally {
    submitBtn.classList.remove('loading');
    btnText.textContent = "Guardar Expediente";
  }
});
  </script>
</body>
</html>
