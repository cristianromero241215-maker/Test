// js/admin/expediente.js

// URL de la API de Google Apps Script para el panel de administración
const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbxAmQZ75rabW6vFABM-c1fLE-HbWMbsri0P8CO6Q6aRyBSojOQn6sYVfoWvdz-ECYqEag/exec";

// =========================================
// Lógica de Autenticación
// =========================================
if (localStorage.getItem('isAdminLoggedIn') !== 'true') {
  window.location.href = 'login.html';
}

document.getElementById('logoutBtn')?.addEventListener('click', () => {
  localStorage.removeItem('isAdminLoggedIn');
  window.location.href = 'login.html';
});

// =========================================
// Funciones de utilidad
// =========================================
function showNotification(message, type = 'success') {
  const container = document.getElementById('notification-container');
  if (!container) return;
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  container.appendChild(notification);
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// =========================================
// Lógica del Formulario
// =========================================
const form = document.getElementById('expedienteForm');
const submitBtn = form.querySelector('.btn-primary');

form?.addEventListener('submit', async (e) => {
  e.preventDefault();

  submitBtn.classList.add('loading');
  const btnText = submitBtn.querySelector('.btn-text');
  btnText.textContent = "Guardando...";

  const data = Object.fromEntries(new FormData(form).entries());
  data.action = 'addExpediente'; // Nuevo comando para Apps Script

  try {
    const res = await fetch(SHEETS_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    const result = await res.json();
    
    if (result.ok) {
      showNotification('✅ Expediente guardado con éxito!', 'success');
      form.reset();
    } else {
      throw new Error(result.message || 'Error desconocido.');
    }
  } catch (error) {
    showNotification('❌ Error al guardar el expediente.', 'error');
    console.error('Error al guardar el expediente:', error);
  } finally {
    submitBtn.classList.remove('loading');
    btnText.textContent = "Guardar Expediente";
  }
});
